!function(a){var b={"private":{dragRequest:function(b,c,d){var e=c.parent.data.key;"over"==d&&(e=c.data.key),jQuery.fn.dialog.showLoader();var f=[{name:"sourceTreeNodeID",value:b.data.key},{name:"treeNodeParentID",value:e}],g=c.parent.getChildren();if(g)for(i=0;i<g.length;i++){var h=g[i];f.push({name:"treeNodeID[]",value:h.data.key})}a.ajax({dataType:"json",type:"POST",data:f,url:CCM_TOOLS_PATH+"/tree/node/drag_request",success:function(a){ccm_parseJSON(a,function(){}),jQuery.fn.dialog.hideLoader()}})},getMenu:function(b,c){var d='<div class="ccm-topic-menu ccm-popover-page-menu popover fade popover fade"><div class="arrow"></div><div class="popover-inner">';d+='<ul class="dropdown-menu">',b.canAddTopicCategoryTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=add-category-node]\').ccmtopicstree(\'initAddNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.addCategory+'" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/add/topic_category?treeNodeParentID="+b.key+'">'+ccmi18n_topics.addCategory+"</a></li>"),b.canAddTopicTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=add-topic-node]\').ccmtopicstree(\'initAddNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.addTopic+'" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/add/topic?treeNodeParentID="+b.key+'">'+ccmi18n_topics.addTopic+"</a></li>"),b.canEditTreeNode&&"topic_category"==b.treeNodeTypeHandle&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=update-category-node]\').ccmtopicstree(\'initUpdateCategoryNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.editCategory+'" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/edit/topic_category?treeNodeID="+b.key+'">'+ccmi18n_topics.editCategory+"</a></li>",d+="<li><a href=\"#\" onclick=\"$.fn.ccmtopicstree('cloneNode', 'node', "+c.treeID+","+b.key+')">'+ccmi18n_topics.cloneCategory+"</a></li>"),b.canEditTreeNode&&"topic"==b.treeNodeTypeHandle&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=update-topic-node]\').ccmtopicstree(\'initUpdateTopicNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.editTopic+'" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/edit/topic?treeNodeID="+b.key+'">'+ccmi18n_topics.editTopic+"</a></li>",d+="<li><a href=\"#\" onclick=\"$.fn.ccmtopicstree('cloneNode', 'node', "+c.treeID+","+b.key+')">'+ccmi18n_topics.cloneTopic+"</a></li>"),b.canEditTreeNodePermissions&&(d+='<li><a class="dialog-launch" dialog-width="480" dialog-height="auto" dialog-modal="true" dialog-title="'+ccmi18n_topics.editPermissions+'" href="'+CCM_TOOLS_PATH+"/tree/node/permissions?treeNodeID="+b.key+'">'+ccmi18n_topics.editPermissions+"</a></li>"),b.treeNodeParentID>0&&"topic_category"==b.treeNodeTypeHandle&&b.canDeleteTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=remove-tree-node]\').ccmtopicstree(\'initRemoveNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.deleteCategory+'" href="'+CCM_TOOLS_PATH+"/tree/node/remove?treeNodeID="+b.key+'">'+ccmi18n_topics.deleteCategory+"</a></li>"),b.treeNodeParentID>0&&"topic"==b.treeNodeTypeHandle&&b.canDeleteTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=remove-tree-node]\').ccmtopicstree(\'initRemoveNodeForm\', '+c.treeID+');" dialog-height="auto" dialog-modal="false" dialog-title="'+ccmi18n_topics.deleteTopic+'" href="'+CCM_TOOLS_PATH+"/tree/node/remove?treeNodeID="+b.key+'">'+ccmi18n_topics.deleteTopic+"</a></li>"),d+="</ul></div></div>";var e=a(d);return 0==e.find("li").length?!1:e},reloadNode:function(a,b,c){var d=a.ajaxData;d.treeNodeParentID=b.data.key;var e={url:CCM_TOOLS_PATH+"/tree/node/load",data:d,success:function(){c&&c()}};b.appendAjax(e)},setupDialogForm:function(b,c){b.closest(".ui-dialog").find("button[type=submit]").on("click",function(){b.trigger("submit")}),b.on("submit",function(){jQuery.fn.dialog.showLoader();var d=b.serializeArray();return a.ajax({dataType:"json",type:"post",data:d,url:b.attr("action"),success:function(a){1==a.error?ConcreteAlert.dialog("Error",'<div class="alert alert-danger">'+a.messages.join("<br>")+"</div>"):(jQuery.fn.dialog.closeTop(),c(a))},error:function(a){ConcreteAlert.dialog("Error",'<div class="alert alert-danger">'+a.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1})}},initAddNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]");if(b.length)for(i=0;i<b.length;i++){var e=d.dynatree("getTree").getNodeByKey(b[i].treeNodeParentID);e.addChild(b[i])}else{var e=d.dynatree("getTree").getNodeByKey(b.treeNodeParentID);e.addChild(b)}e.expand()})},cloneNode:function(c,d,e){var f=a("[data-topic-tree="+d+"]");return a.ajax({dataType:"json",type:"post",data:{treeNodeID:e},url:CCM_TOOLS_PATH+"/tree/node/duplicate/"+c,success:function(a){if(1==a.error)ConcreteAlert.dialog("Error",'<div class="alert alert-danger">'+a.messages.join("<br>")+"</div>");else{jQuery.fn.dialog.closeTop();var c=f.dynatree("getTree").getNodeByKey(a.treeNodeParentID);c.setLazyNodeStatus(DTNodeStatus_Loading),b.private.reloadNode(f.data("options"),c,function(){c.setLazyNodeStatus(DTNodeStatus_Ok)})}},error:function(a){ConcreteAlert.dialog("Error",'<div class="alert alert-danger">'+a.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1},initUpdateCategoryNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.key);e.data=b,e.render()})},initUpdateTopicNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.key);e.data=b,e.render()})},initRemoveNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.treeNodeID);e.remove()})},init:function(c){var c=a.extend({readonly:!1,chooseNodeInForm:!1,onSelect:!1,selectNodesByKey:[]},c),d=!1,e=!1;if(c.treeNodeParentID)var f={treeNodeParentID:c.treeNodeParentID};else var f={treeID:c.treeID};var g=!0;c.chooseNodeInForm&&(d=!0,g=!1,e={checkbox:"dynatree-radio"},c.selectNodesByKey.length&&(f.treeNodeSelectedIDs=c.selectNodesByKey)),"multiple"===c.chooseNodeInForm&&(d=!0,g=!1,e={checkbox:"dynatree-checkbox"},c.selectNodesByKey.length&&(f.treeNodeSelectedIDs=c.selectNodesByKey));var h=1;c.selectMode&&(h=c.selectMode);var i=2;return c.minExpandLevel&&(i=c.minExpandLevel),this.each(function(){if(c.treeNodeParentID)var g=CCM_TOOLS_PATH+"/tree/node/load";else var g=CCM_TOOLS_PATH+"/tree/load";var j=a(this);c.ajaxData=f,j.data("options",c),j.dynatree({autoFocus:!1,onSelect:function(a,b){c.chooseNodeInForm&&c.onSelect(a,b)},selectMode:h,checkbox:d,classNames:e,minExpandLevel:i,clickFolderMode:1,initAjax:{url:g,type:"post",data:f},onLazyRead:function(a){b.private.reloadNode(c,a)},onPostInit:function(){var b=j;if(c.readonly&&b.dynatree("disable"),c.chooseNodeInForm){var d=b.dynatree("getTree"),d=d.getSelectedNodes();if(d[0]){var e=d[0];c.onSelect(!0,e)}}if(d){a.map(d,function(a){a.makeVisible()})}},onClick:function(d,e){if("expander"==d.getEventTargetType(e))return!0;if(c.chooseNodeInForm&&"checkbox"!=d.getEventTargetType(e))return!1;if(!d.getEventTargetType(e))return!1;if(!c.chooseNodeInForm&&"title"==d.getEventTargetType(e)&&!c.noForm){var f=b.private.getMenu(d.data,c);if(f){var g=new ConcreteMenu(a(d.span),{menu:f,launcher:"none"});g.show(e)}}},dnd:{onDragStart:function(){return c.noDrag?!1:!0},onDragStop:function(){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(){return!0},onDragOver:function(a,b,c){a.data.treeNodeType;return"over"===c&&jQuery.inArray(a.data.treeNodeTypeHandle,["topic"])>-1?!1:a.isDescendantOf(b)?!1:!0},onDrop:function(a,c,d){c.move(a,d),b.private.dragRequest(c,a,d)}}})})}};a.fn.ccmtopicstree=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?void a.error("Method "+c+" does not exist on jQuery.ccmtopicstree"):b.init.apply(this,arguments)}}(jQuery,window);