!function(a,b,c){"use strict";function d(a,c){var d=this;return c=c||{},c=b.extend({readonly:!1,chooseNodeInForm:!1,onSelect:!1,treeID:!1,allowFolderSelection:!0,selectNodesByKey:[],removeNodesByKey:[],removeNodesByCallback:!1,ajaxData:{}},c),d.options=c,d.$element=a,d.setupTree(),d.setupTreeEvents(),d.$element}d.prototype={setupTreeEvents:function(){var a=this;ConcreteEvent.subscribe("ConcreteMenuShow",function(c,d){var e=d.menu.$menu.attr("data-tree-menu");if(e&&e==a.options.treeID){var f=d.menuElement;f.find("a[data-tree-action]").on("click.concreteMenu",function(c){c.preventDefault();var d=b(this).attr("data-tree-action-url"),e=b(this).attr("data-tree-action"),f=b(this).attr("dialog-title"),g=b(this).attr("dialog-width"),h=b(this).attr("dialog-height");switch(e){case"clone-node":a.cloneNode(b(this).attr("data-tree-node-id"));break;default:if(!f)switch(e){case"add-node":f=ccmi18n_tree.add;break;case"edit-node":f=ccmi18n_tree.edit;break;case"delete-node":f=ccmi18n_tree["delete"]}g||(g=550),h||(h="auto"),jQuery.fn.dialog.open({title:f,href:d,width:g,modal:!1,height:h})}})}}),ConcreteEvent.subscribe("ConcreteTreeAddTreeNode",function(c,d){var e=b("[data-tree="+a.options.treeID+"]"),f=d.node;if(f.length)for(var g=0;g<f.length;g++){var h=e.dynatree("getTree").getNodeByKey(f[g].treeNodeParentID);h.addChild(f[g])}else{var h=e.dynatree("getTree").getNodeByKey(f.treeNodeParentID);h.addChild(f)}}),ConcreteEvent.subscribe("ConcreteTreeUpdateTreeNode",function(c,d){var e=b("[data-tree="+a.options.treeID+"]"),f=e.dynatree("getTree").getNodeByKey(d.node.key);f.data=d.node,f.render()}),ConcreteEvent.subscribe("ConcreteTreeDeleteTreeNode",function(c,d){var e=b("[data-tree="+a.options.treeID+"]"),f=e.dynatree("getTree").getNodeByKey(d.node.treeNodeID);f.remove()})},dragRequest:function(a,c,d){var e=c.parent.data.key;"over"==d&&(e=c.data.key),jQuery.fn.dialog.showLoader();var f=[{name:"sourceTreeNodeID",value:a.data.key},{name:"treeNodeParentID",value:e}],g=c.parent.getChildren();if(g)for(var h=0;h<g.length;h++){var i=g[h];f.push({name:"treeNodeID[]",value:i.data.key})}b.ajax({dataType:"json",type:"POST",data:f,url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/drag_request",success:function(a){ccm_parseJSON(a,function(){}),jQuery.fn.dialog.hideLoader()}})},setupTree:function(){var a=this,c=a.options,d={},e=!1,f={};0!=a.options.ajaxData&&(f=a.options.ajaxData),c.treeNodeParentID?f.treeNodeParentID=c.treeNodeParentID:f.treeID=c.treeID,c.allowFolderSelection&&(f.allowFolderSelection=1);var g=!0;c.chooseNodeInForm&&(e=!0,g=!1,d={checkbox:"dynatree-radio"},c.selectNodesByKey.length&&(f.treeNodeSelectedIDs=c.selectNodesByKey)),"multiple"===c.chooseNodeInForm&&(e=!0,g=!1,d={checkbox:"dynatree-checkbox"},c.selectNodesByKey.length&&(f.treeNodeSelectedIDs=c.selectNodesByKey));var h=1;c.selectMode&&(h=c.selectMode);var i=2;if(c.minExpandLevel&&(i=c.minExpandLevel),c.treeNodeParentID)var j=CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/load_starting";else var j=CCM_DISPATCHER_FILENAME+"/ccm/system/tree/load";b(a.$element).dynatree({autoFocus:!1,initAjax:{url:j,type:"post",data:f},onLazyRead:function(b){a.reloadNode(b)},onSelect:function(a,b){c.chooseNodeInForm&&c.onSelect(a,b)},selectMode:h,checkbox:e,classNames:d,minExpandLevel:i,clickFolderMode:1,onPostInit:function(){var d=a.$element;if(c.removeNodesByKey.length)for(var e=0;e<c.removeNodesByKey.length;e++){var f=c.removeNodesByKey[e],g=this.getNodeByKey(f);g&&g.remove()}if(c.readOnly&&d.dynatree("disable"),c.chooseNodeInForm){var h=d.dynatree("getTree");if(h=h.getSelectedNodes(),h[0]){var g=h[0];c.onSelect(!0,g)}}if(h){b.map(h,function(a){a.makeVisible()})}},onClick:function(a,d){if("expander"==a.getEventTargetType(d))return!0;if(c.chooseNodeInForm&&"checkbox"!=a.getEventTargetType(d))return!1;if(!a.getEventTargetType(d))return!1;if(!c.chooseNodeInForm&&"title"==a.getEventTargetType(d)){var e=a.data.treeNodeMenu;if(e){var f=new ConcreteMenu(b(a.span),{menu:e,handle:"none"});f.show(d)}}return!0},fx:{height:"toggle",duration:200},dnd:{onDragStart:function(a){return c.chooseNodeInForm?!1:!0},onDragStop:function(a){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(a,b){return!0},onDragOver:function(a,b,c){return a.parent.data.treeNodeID||"1"===a.data.treeNodeID?"over"!=c&&1==a.data.treeNodeID?!1:b.data.treeNodeID==a.data.treeNodeID?!1:a.data.treeNodeID||"after"!=c?a.isDescendantOf(b)?!1:!0:!1:!1},onDrop:function(b,c,d,e,f){c.move(b,d),a.dragRequest(c,b,d)}}})},reloadNode:function(a,b){var c=this,d=(c.options,0!=c.options.ajaxData?c.options.ajaxData:{});d.treeNodeParentID=a.data.key;var e={url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/load",data:d,success:function(){b&&b()}};a.appendAjax(e)},cloneNode:function(a){var c=this,d=b("[data-tree="+c.options.treeID+"]");return b.ajax({dataType:"json",type:"post",data:{treeNodeID:a},url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/duplicate",success:function(a){if(1==a.error)ConcreteAlert.dialog(ccmi18n.error,a.errors.join("<br>"));else{jQuery.fn.dialog.closeTop();var b=d.dynatree("getTree").getNodeByKey(a.treeNodeParentID);b.setLazyNodeStatus(DTNodeStatus_Loading),c.reloadNode(b,function(){b.setLazyNodeStatus(DTNodeStatus_Ok)})}},error:function(a){ConcreteAlert.dialog(ccmi18n.error,'<div class="alert alert-danger">'+a.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1}},b.fn.concreteTree=function(a){return b.each(b(this),function(c,e){new d(b(this),a)})},a.ConcreteTree=d}(this,$,_);